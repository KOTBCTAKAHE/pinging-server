on:
  repository_dispatch:
  workflow_dispatch:
  # schedule:
  #   - cron: '*/5 * * * *'
jobs:
  build:
    name: Fetch data
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 16
      - run: npm ci
      - name: Run node file
        run: npm run build --if-present
        env:
          URL: ${{ secrets.URL }}
      
      # - uses: stefanzweifel/git-auto-commit-action@v4
      #   with:
      #     commit_message: Data update
      
      - name: Commit report
        run: |
          git config --global user.name 'atageldi194229'
          git config --global user.email 'atageldi194229@gmail.com'
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
          git add -A
          git commit -am "Automated data update"
          git push

  ###################################
  ### Run when a schedule success ###
  ###################################
  success_job:
    name: Success job
    runs-on: ubuntu-latest
    needs: [build]

  ###################################
  ### Run when a schedule failed ###
  ###################################
  failure_job:
    name: Failure job
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && failure()  # Run when a schedule failed
    needs: [build]
  

  ###################################
  ### Run in the end              ###
  ###################################
  run_in_the_end:
    name: Run in the end for recursion
    runs-on: ubuntu-latest
    needs: [success_job, failure_job]
    steps:
      - uses: actions/checkout@v3

      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 16

      - name: Wait 2 minutes
        run: node waiter.js 120

      - name: Retry the workflow
        run: |
          curl -i \
          -X POST \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: token ${{ secrets.ACTIONS_PAT }}" \
          https://api.github.com/repos/estruyf/doctor/actions/workflows/34892269/dispatches \
          -d '{"ref": "${{ github.ref }}" }'

  # ###################################
  # ### Run recursively             ###
  # ###################################
  # restart_when_recursivly:
  #   name: Restarts the scheduled after a time
  #   runs-on: ubuntu-latest
  #   # if: github.event_name == 'schedule' && failure()  # Run when a schedule failed
  #   needs: [build]
  #   steps:
  #     - uses: actions/checkout@v3

  #     - name: Use Node.js
  #       uses: actions/setup-node@v3
  #       with:
  #         node-version: 16

  #     - name: Wait 2 minutes
  #       run: node waiter.js 120

  #     - name: Retry the workflow
  #       run: |
  #         curl -i \
  #         -X POST \
  #         -H "Accept: application/vnd.github.v3+json" \
  #         -H "Authorization: token ${{ secrets.ACTIONS_PAT }}" \
  #         https://api.github.com/repos/estruyf/doctor/actions/workflows/34892269/dispatches \
  #         -d '{"ref": "${{ github.ref }}" }'

  # ###################################
  # ### Run when a schedule failed  ###
  # ###################################
  # restart_when_fail:
  #   name: Restarts the scheduled run when it failed
  #   runs-on: ubuntu-latest
  #   if: github.event_name == 'schedule' && failure()
  #   needs: [build]
  #   steps:
  #     - uses: actions/checkout@v3

  #     - name: Use Node.js
  #       uses: actions/setup-node@v3
  #       with:
  #         node-version: 16

  #     - name: Wait 2 minutes
  #       run: node waiter.js 120

  #     - name: Retry the workflow
  #       run: |
  #         curl -i \
  #         -X POST \
  #         -H "Accept: application/vnd.github.v3+json" \
  #         -H "Authorization: token ${{ secrets.ACTIONS_PAT }}" \
  #         https://api.github.com/repos/estruyf/doctor/actions/workflows/34892269/dispatches \
  #         -d '{"ref": "${{ github.ref }}" }'
